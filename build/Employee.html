<?php
session_start();
require_once __DIR__ . '/../config/Database.php';
require_once __DIR__ . '/../services/AccountService.php';
require_once __DIR__ . '/../services/BillService.php';

$db = new Database();
$accountService = new AccountService();
$billService = new BillService();
?>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="apple-touch-icon" sizes="76x76" href="./assets/img/apple-icon.png" />
    <link rel="icon" type="image/png" href="./assets/img/favicon.png" />
    <title>NWC Billing System - Control Central</title>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet" />
    <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
    <link href="./assets/css/nucleo-icons.css" rel="stylesheet" />
    <link href="./assets/css/nucleo-svg.css" rel="stylesheet" />
    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <link href="./assets/css/argon-dashboard-tailwind.css?v=1.0.1" rel="stylesheet" />
    <link href="./assets/css/perfect-scrollbar.css" rel="stylesheet" />
    <link href="./assets/css/tooltips.css" rel="stylesheet" />
    <style>
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .page-fade-in { animation: fadeIn 0.3s ease-in-out; }
        
        body { position: relative; }
        .absolute.bg-blue-500 { position: fixed !important; top: 0 !important; z-index: 1 !important; }
        main { position: relative; z-index: 10; }
        
        .section-header { cursor: pointer; user-select: none; transition: color 0.2s; }
        .section-header:hover { color: #3b82f6; }
        .section-header i { transition: transform 0.3s ease; display: inline-block; }
        
        .section-content { display: block; max-height: 1000px; overflow: hidden; transition: max-height 0.3s ease, padding 0.3s ease; }
        .section-header.collapsed ~ .section-content { max-height: 0 !important; padding: 0 !important; }
        .section-header.collapsed i { transform: rotate(-90deg); }
    </style>
</head>
<body class="m-0 font-sans text-base antialiased font-normal dark:bg-slate-900 leading-default bg-gray-50 text-slate-500">
    <div class="absolute w-full bg-blue-500 dark:hidden min-h-75"></div>
    
    <!-- SIDEBAR NAVIGATION -->
    <aside id="sidenav-main" class="fixed inset-y-0 flex-wrap items-center justify-between block w-full p-0 my-4 overflow-y-auto antialiased transition-transform duration-200 -translate-x-full bg-white border-0 shadow-xl dark:shadow-none dark:bg-slate-850 max-w-64 ease-nav-brand z-990 xl:ml-6 rounded-2xl xl:left-0 xl:translate-x-0" aria-expanded="false">
        <div class="h-19">
            <i class="absolute top-0 right-0 p-4 opacity-50 cursor-pointer fas fa-times dark:text-white text-slate-400 xl:hidden" sidenav-close></i>
            <a class="block px-8 py-6 m-0 text-sm whitespace-nowrap dark:text-white text-slate-700" href="javascript:void(0)" onclick="app.navigate('dashboard')">
                <i class="ni ni-water-bottle text-2xl text-blue-500"></i>
                <span class="ml-1 font-semibold transition-all duration-200 ease-nav-brand">NWC Billing</span>
            </a>
        </div>

        <hr class="h-px mt-0 bg-transparent bg-gradient-to-r from-transparent via-black/40 to-transparent dark:bg-gradient-to-r dark:from-transparent dark:via-white dark:to-transparent" />

        <div class="items-center block w-auto max-h-screen overflow-auto h-sidenav grow basis-full">
            <ul class="flex flex-col pl-0 mb-0">
                <li class="mt-0.5 w-full"><a class="py-2.7 bg-blue-500/13 dark:text-white dark:opacity-80 text-sm ease-nav-brand my-0 mx-2 flex items-center whitespace-nowrap rounded-lg px-4 font-semibold text-slate-700 transition-colors nav-link active" href="javascript:void(0)" onclick="app.navigate('dashboard')" data-page="dashboard"><i class="ni ni-tv-2 text-xl text-blue-500 mr-2"></i><span>Dashboard</span></a></li>
                <li class="mt-0.5 w-full"><a class="dark:text-white dark:opacity-80 py-2.7 text-sm ease-nav-brand my-0 mx-2 flex items-center whitespace-nowrap px-4 transition-colors nav-link" href="javascript:void(0)" onclick="app.navigate('search')" data-page="search"><i class="ni ni-zoom-split-in text-xl text-cyan-500 mr-2"></i><span>Search Accounts</span></a></li>
                <li class="mt-0.5 w-full"><a class="dark:text-white dark:opacity-80 py-2.7 text-sm ease-nav-brand my-0 mx-2 flex items-center whitespace-nowrap px-4 transition-colors nav-link" href="javascript:void(0)" onclick="app.navigate('meter')" data-page="meter"><i class="ni ni-chart-bar-32 text-xl text-emerald-500 mr-2"></i><span>Meter Readings</span></a></li>
                <li class="mt-0.5 w-full"><a class="dark:text-white dark:opacity-80 py-2.7 text-sm ease-nav-brand my-0 mx-2 flex items-center whitespace-nowrap px-4 transition-colors nav-link" href="javascript:void(0)" onclick="app.navigate('bills')" data-page="bills"><i class="ni ni-credit-card text-xl text-orange-500 mr-2"></i><span>Bills</span></a></li>
                <li class="mt-0.5 w-full"><a class="dark:text-white dark:opacity-80 py-2.7 text-sm ease-nav-brand my-0 mx-2 flex items-center whitespace-nowrap px-4 transition-colors nav-link" href="javascript:void(0)" onclick="app.navigate('reports')" data-page="reports"><i class="ni ni-chart-pie-36 text-xl text-red-600 mr-2"></i><span>Reports</span></a></li>
            </ul>

            <hr class="h-px mt-4 bg-transparent bg-gradient-to-r from-transparent via-black/40 to-transparent" />

            <ul class="flex flex-col pl-0 mb-0">
                <li class="w-full mt-4"><h6 class="pl-6 ml-2 text-xs font-bold leading-tight uppercase dark:text-white opacity-60">Settings</h6></li>
                <li class="mt-0.5 w-full"><a class="dark:text-white dark:opacity-80 py-2.7 text-sm ease-nav-brand my-0 mx-2 flex items-center whitespace-nowrap px-4 transition-colors nav-link" href="javascript:void(0)" onclick="app.navigate('profile')" data-page="profile"><i class="ni ni-single-02 text-xl mr-2"></i><span>Profile</span></a></li>
            </ul>
        </div>
    </aside>

    <!-- MAIN CONTENT AREA -->
    <main class="relative h-full max-h-screen transition-all duration-200 ease-in-out xl:ml-68 rounded-xl">
        <!-- NAVBAR -->
        <nav class="relative flex flex-wrap items-center justify-between px-0 py-2 mx-6 transition-all ease-in shadow-none duration-250 rounded-2xl lg:flex-nowrap lg:justify-start" navbar-main navbar-scroll="false">
            <div class="flex items-center justify-between w-full px-4 py-1 mx-auto flex-wrap-inherit">
                <nav>
                    <ol class="flex flex-wrap pt-1 mr-12 bg-transparent rounded-lg sm:mr-16">
                        <li class="text-sm leading-normal"><a class="text-white opacity-50" href="javascript:void(0)">Pages</a></li>
                        <li class="text-sm pl-2 capitalize leading-normal text-white before:float-left before:pr-2 before:text-white before:content-['/']" id="breadcrumb">Dashboard</li>
                    </ol>
                    <h6 class="mb-0 font-bold text-white capitalize" id="pageTitle">Dashboard</h6>
                </nav>

                <div class="flex items-center mt-2 grow sm:mt-0 sm:mr-6 md:mr-0 lg:flex lg:basis-auto">
                    <div class="flex md:mr-4">
                        <input type="text" placeholder="Type here..." class="px-3 py-2 text-sm border border-slate-200 rounded-lg dark:bg-slate-850 dark:border-slate-600 dark:text-white" />
                    </div>
                    <ul class="flex flex-row justify-end pl-0 mb-0 list-none md-max:w-full">
                        <li class="flex items-center"><a href="javascript:void(0)" class="block px-0 py-2 text-white transition-all ease-nav-brand text-sm"><i class="fa fa-user"></i></a></li>
                        <li class="flex items-center"><a href="javascript:void(0)" class="block px-0 py-2 text-white transition-all ease-nav-brand text-sm"><i class="fa fa-cog"></i></a></li>
                        <li class="flex items-center"><a href="javascript:void(0)" class="block px-0 py-2 text-white transition-all ease-nav-brand text-sm"><i class="fa fa-bell"></i></a></li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- PAGE CONTENT -->
        <div class="w-full px-6 py-6 mx-auto" id="pageContent"></div>
    </main>

    <!-- SIDENAV TOGGLE FOR MOBILE -->
    <div class="fixed inset-0 z-50 hidden bg-black/20" sidenav-backdrop></div>

    <script src="./assets/js/perfect-scrollbar.js"></script>
    <script src="./assets/js/argon-dashboard-tailwind.js?v=1.0.0"></script>

    <script>
        const app = {
            currentPage: 'dashboard',

            navigate(pageName) {
                app.currentPage = pageName;
                const pageContent = document.getElementById('pageContent');
                const breadcrumb = document.getElementById('breadcrumb');
                const pageTitle = document.getElementById('pageTitle');
                
                if (pages[pageName]) {
                    const page = pages[pageName];
                    pageTitle.textContent = page.title;
                    breadcrumb.textContent = page.breadcrumb;
                    pageContent.className = 'w-full px-6 py-6 mx-auto page-fade-in';
                    page.render(pageContent);
                    
                    // Update nav link
                    document.querySelectorAll('.nav-link').forEach(link => {
                        link.classList.remove('bg-blue-500/13', 'active');
                    });
                    document.querySelector(`[data-page="${pageName}"]`).classList.add('bg-blue-500/13', 'active');
                    
                    // Close mobile sidebar
                    if (window.innerWidth < 1024) {
                        document.querySelector('[sidenav-main]').classList.add('-translate-x-full');
                    }
                }
            },

            toggleSection(event) {
                const btn = event.currentTarget;
                btn.classList.toggle('collapsed');
                event.preventDefault();
                event.stopPropagation();
            },

            searchBills(searchType) {
                const searchMap = {
                    'personName': 'billSearchPersonName',
                    'billId': 'billSearchBillId',
                    'accountId': 'billSearchAccountId',
                    'billDate': 'billSearchBillDate',
                    'crNote': 'billSearchCrNote',
                    'charType': 'billSearchCharType',
                    'charValue': 'billSearchCharValue'
                };
                
                const inputId = searchMap[searchType];
                const searchValue = document.getElementById(inputId)?.value;
                
                if (!searchValue) {
                    alert('Please enter a search value');
                    return;
                }
                
                // Call PHP API endpoint
                const apiUrl = new URL('/NWCBilling/api/bills.php', window.location.origin);
                apiUrl.searchParams.append('action', 'search');
                apiUrl.searchParams.append(searchType === 'crNote' || searchType === 'charType' || searchType === 'charValue' ? 'personName' : searchType, searchValue);
                
                fetch(apiUrl.toString())
                    .then(response => response.json())
                    .then(data => {
                        const tableBody = document.getElementById('billResultsTable');
                        if (data.success && data.data.length > 0) {
                            tableBody.innerHTML = data.data.map(bill => `
                                <tr class="border-b border-gray-200 dark:border-slate-700 hover:bg-gray-50 dark:hover:bg-slate-800 cursor-pointer" onclick="app.openBillModal({personName:'${bill.personName}', billStatus:'${bill.billStatus}', billDate:'${bill.billDate}', dueDate:'${bill.dueDate}', currentCharges:'${bill.currentCharges}', billId:'${bill.billId}', originalBillDate:'${bill.originalBillDate}', accountId:'${bill.accountId}'})">
                        <td class="px-4 py-4 text-slate-700 dark:text-white text-xs">${bill.personName}</td>
                        <td class="px-4 py-4"><span class="px-2 py-1 rounded text-xs font-semibold ${bill.billStatus === 'Complete' ? 'bg-emerald-500/20 text-emerald-600' : 'bg-orange-500/20 text-orange-600'}">${bill.billStatus}</span></td>
                        <td class="px-4 py-4 text-slate-700 dark:text-white text-xs">${bill.billDate}</td>
                        <td class="px-4 py-4 text-slate-700 dark:text-white text-xs">${bill.dueDate}</td>
                        <td class="px-4 py-4 text-slate-700 dark:text-white text-xs font-semibold">${bill.currentCharges}</td>
                        <td class="px-4 py-4 text-slate-700 dark:text-white text-xs">${bill.billId}</td>
                        <td class="px-4 py-4 text-slate-700 dark:text-white text-xs">${bill.originalBillDate}</td>
                        <td class="px-4 py-4 text-blue-600 text-xs font-semibold">${bill.accountId}</td>
                    </tr>
                            `).join('');
                        } else {
                            tableBody.innerHTML = '<tr><td colspan="8" class="px-4 py-4 text-center text-slate-500">No results found</td></tr>';
                        }
                    })
                    .catch(error => {
                        console.error('Search error:', error);
                        alert('Error searching bills. Please try again.');
                    });
            },

            openBillModal(billData) {
                app.selectedBill = billData;
                const modal = document.getElementById('billModal');
                modal.classList.remove('hidden');
                modal.classList.add('flex');
                
                // Populate modal with bill data
                document.getElementById('modalPersonName').textContent = billData.personName;
                document.getElementById('modalBillId').textContent = billData.billId;
                document.getElementById('modalAccountId').textContent = billData.accountId;
                document.getElementById('modalBillStatus').textContent = billData.billStatus;
                document.getElementById('modalBillDate').textContent = billData.billDate;
                document.getElementById('modalDueDate').textContent = billData.dueDate;
                document.getElementById('modalCurrentCharges').textContent = billData.currentCharges;
                document.getElementById('modalOriginalBillDate').textContent = billData.originalBillDate;
            },

            closeBillModal() {
                const modal = document.getElementById('billModal');
                modal.classList.add('hidden');
                modal.classList.remove('flex');
                app.selectedBill = null;
            }
        };

        const pages = {
            dashboard: {
                title: 'Dashboard',
                breadcrumb: 'Dashboard',
                render(container) {
                    container.innerHTML = `<div class="flex flex-wrap -mx-3"><div class="w-full max-w-full px-3 mb-6 sm:w-1/2 sm:flex-none xl:mb-0 xl:w-1/4"><div class="relative flex flex-col min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border"><div class="flex-auto p-4"><div class="flex flex-row -mx-3"><div class="flex-none w-2/3 max-w-full px-3"><div><p class="mb-0 font-sans text-sm font-semibold leading-normal uppercase dark:text-white dark:opacity-60">Total Accounts</p><h5 class="mb-2 font-bold dark:text-white">1,245</h5><p class="mb-0 dark:text-white dark:opacity-60"><span class="text-sm font-bold leading-normal text-emerald-500">+12%</span> this month</p></div></div><div class="px-3 text-right basis-1/3"><div class="inline-block w-12 h-12 text-center rounded-circle bg-gradient-to-tl from-blue-500 to-violet-500"><i class="ni leading-none ni-single-02 text-lg relative top-3.5 text-white"></i></div></div></div></div></div></div><div class="w-full max-w-full px-3 mb-6 sm:w-1/2 sm:flex-none xl:mb-0 xl:w-1/4"><div class="relative flex flex-col min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border"><div class="flex-auto p-4"><div class="flex flex-row -mx-3"><div class="flex-none w-2/3 max-w-full px-3"><div><p class="mb-0 font-sans text-sm font-semibold leading-normal uppercase dark:text-white dark:opacity-60">Water Consumed</p><h5 class="mb-2 font-bold dark:text-white">45.2K m¬≥</h5><p class="mb-0 dark:text-white dark:opacity-60"><span class="text-sm font-bold leading-normal text-red-600">+5%</span> from last month</p></div></div><div class="px-3 text-right basis-1/3"><div class="inline-block w-12 h-12 text-center rounded-circle bg-gradient-to-tl from-emerald-500 to-teal-400"><i class="ni leading-none ni-water-bottle text-lg relative top-3.5 text-white"></i></div></div></div></div></div></div><div class="w-full max-w-full px-3 mb-6 sm:w-1/2 sm:flex-none xl:mb-0 xl:w-1/4"><div class="relative flex flex-col min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border"><div class="flex-auto p-4"><div class="flex flex-row -mx-3"><div class="flex-none w-2/3 max-w-full px-3"><div><p class="mb-0 font-sans text-sm font-semibold leading-normal uppercase dark:text-white dark:opacity-60">Total Revenue</p><h5 class="mb-2 font-bold dark:text-white">$125.3K</h5><p class="mb-0 dark:text-white dark:opacity-60"><span class="text-sm font-bold leading-normal text-emerald-500">+8.5%</span> growth</p></div></div><div class="px-3 text-right basis-1/3"><div class="inline-block w-12 h-12 text-center rounded-circle bg-gradient-to-tl from-orange-500 to-yellow-500"><i class="ni leading-none ni-money-coins text-lg relative top-3.5 text-white"></i></div></div></div></div></div></div><div class="w-full max-w-full px-3 sm:w-1/2 sm:flex-none xl:w-1/4"><div class="relative flex flex-col min-w-0 break-words bg-white shadow-xl dark:bg-slate-850 dark:shadow-dark-xl rounded-2xl bg-clip-border"><div class="flex-auto p-4"><div class="flex flex-row -mx-3"><div class="flex-none w-2/3 max-w-full px-3"><div><p class="mb-0 font-sans text-sm font-semibold leading-normal uppercase dark:text-white dark:opacity-60">Pending Bills</p><h5 class="mb-2 font-bold dark:text-white">234</h5><p class="mb-0 dark:text-white dark:opacity-60"><span class="text-sm font-bold leading-normal text-red-600">3 overdue</span></p></div></div><div class="px-3 text-right basis-1/3"><div class="inline-block w-12 h-12 text-center rounded-circle bg-gradient-to-tl from-red-600 to-orange-600"><i class="ni leading-none ni-single-copy-04 text-lg relative top-3.5 text-white"></i></div></div></div></div></div></div></div><div class="flex flex-wrap mt-6 -mx-3"><div class="w-full max-w-full px-3 mt-0"><div class="border-black/12.5 dark:bg-slate-850 dark:shadow-dark-xl shadow-xl relative z-20 flex min-w-0 flex-col break-words rounded-2xl border-0 border-solid bg-white bg-clip-border"><div class="border-black/12.5 mb-0 rounded-t-2xl border-b border-solid p-6 pt-4 pb-3"><h6 class="capitalize dark:text-white">Welcome to NWC Billing System</h6></div><div class="flex-auto p-6"><p class="dark:text-white mb-4">Fast, seamless internal navigation with Oracle-like experience. No page reloads, just smooth transitions.</p><p class="dark:text-white"><strong>Navigation:</strong> Use the sidebar menu to switch between sections instantly.</p></div></div></div></div>`;
                }
            },
            search: {
                title: 'Search Accounts',
                breadcrumb: 'Search / Accounts',
                render(container) {
                    container.innerHTML = `<div class="w-full max-w-full"><div class="border-black/12.5 dark:bg-slate-850 dark:shadow-dark-xl shadow-xl relative z-20 flex min-w-0 flex-col break-words rounded-2xl border-0 border-solid bg-white bg-clip-border mb-6"><div class="border-black/12.5 mb-0 rounded-t-2xl border-b-0 border-solid p-6 pt-4 pb-0"><h6 class="capitalize dark:text-white">Account Search</h6></div><div class="flex-auto p-6"><div class="mb-4"><label class="block text-sm font-semibold text-slate-700 dark:text-white mb-2">Search By</label><select id="searchType" onchange="app.updateSearchFields()" class="w-full px-4 py-2 border border-solid border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none dark:bg-slate-800 dark:text-white"><option value="name">Name and Address</option><option value="account_id">Account ID</option><option value="phone">Phone Number</option></select></div><div id="searchFields" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4"></div><div class="flex gap-2"><button onclick="app.performSearch()" class="inline-flex items-center px-8 py-2 font-bold text-white uppercase bg-blue-500 border-0 rounded-lg text-sm"><i class="ni ni-zoom-split-in mr-2"></i>Search</button><button onclick="app.clearSearch()" class="inline-flex items-center px-8 py-2 font-bold text-slate-700 uppercase bg-gray-200 border-0 rounded-lg text-sm dark:bg-slate-700 dark:text-white"><i class="ni ni-reload mr-2"></i>Clear</button></div></div></div></div><div id="resultsSection" class="w-full max-w-full" style="display:none"><div class="border-black/12.5 dark:bg-slate-850 dark:shadow-dark-xl shadow-xl relative z-20 flex min-w-0 flex-col break-words rounded-2xl border-0 border-solid bg-white bg-clip-border mb-6"><div class="border-black/12.5 mb-0 rounded-t-2xl border-b border-solid p-6 pt-4 pb-3"><h6 class="capitalize dark:text-white">Search Results</h6></div><div id="searchResultsTable" class="overflow-x-auto"></div></div></div><div id="accountDetailsSection" class="w-full max-w-full" style="display:none"><div class="grid grid-cols-1 lg:grid-cols-3 gap-6"><div class="lg:col-span-2"><div class="border-black/12.5 dark:bg-slate-850 dark:shadow-dark-xl shadow-xl relative z-20 flex min-w-0 flex-col break-words rounded-2xl border-0 border-solid bg-white bg-clip-border"><div class="border-black/12.5 mb-0 rounded-t-2xl border-b border-solid p-6 pt-4 pb-0"><div class="flex gap-6 mb-4"><button class="accountTab px-4 py-2 bg-blue-500 text-white rounded-lg font-semibold" data-tab="accountInfo" onclick="app.switchTab(event)">Account Information</button><button class="accountTab px-4 py-2 bg-gray-200 text-slate-700 rounded-lg dark:bg-slate-700 dark:text-white" data-tab="customerInfo" onclick="app.switchTab(event)">Customer</button><button class="accountTab px-4 py-2 bg-gray-200 text-slate-700 rounded-lg dark:bg-slate-700 dark:text-white" data-tab="billingInfo" onclick="app.switchTab(event)">Bill/Payment Tree</button><button class="accountTab px-4 py-2 bg-gray-200 text-slate-700 rounded-lg dark:bg-slate-700 dark:text-white" data-tab="meterInfo" onclick="app.switchTab(event)">Meter</button></div></div><div class="flex-auto p-6"><div id="accountInfo-tab" class="accountTabContent"><div class="space-y-0"><div class="border-b border-gray-200 dark:border-slate-700"><button class="w-full section-header flex items-center justify-between py-4 font-semibold text-slate-700 dark:text-white" onclick="app.toggleSection(event)"><span>Premise Tree</span><i class="ni ni-chevron-down text-sm"></i></button><div class="section-content pb-4 px-2"><div class="text-xs space-y-1"><div class="ml-0 flex items-start"><span class="cursor-pointer hover:text-blue-600 text-slate-700 dark:text-slate-300">üè† Premise - N/A, ŸÇÿµÿ™Ÿä, Home, Al Qasim Directorate</span></div><div class="ml-4 text-slate-600 dark:text-slate-400">(House Connection Number 10425382)</div><div class="ml-4 mt-1 flex items-start"><span class="cursor-pointer hover:text-blue-600 text-slate-700 dark:text-slate-300">üìã SP - N/A, ŸÇÿµÿ™Ÿä, Standard Water Service SP Type (NWC)</span></div><div class="ml-6 text-slate-600 dark:text-slate-400">Al Qasim Service Cycle, Route via HHU: 5014 / Active</div><div class="ml-4 mt-1 flex items-start"><span class="cursor-pointer hover:text-blue-600 text-slate-700 dark:text-slate-300">üí≥ Account - 6435980928, ŸÖÿ≠ŸÖÿØ ÿßŸÑÿ¥ÿ±ŸäŸÅŸä</span></div><div class="ml-6 text-slate-600 dark:text-slate-400">Residential Customer Class, SAR86.95</div><div class="ml-4 mt-1 flex items-start"><span class="cursor-pointer hover:text-blue-600 text-slate-700 dark:text-slate-300">üí≥ Account - 4041863188, ÿµÿßŸÑÿ≠ ÿ®ŸÜ ÿπÿ®ÿØÿßŸÑÿπÿ≤Ÿäÿ≤ ÿßŸÑÿ¥ÿ±ŸäŸÅŸä</span></div><div class="ml-6 text-slate-600 dark:text-slate-400">Residential Customer Class, SAR7,228.91</div><div class="ml-4 mt-1 text-slate-600 dark:text-slate-400">üìå Historical service agreement(s) exist.</div></div></div></div><div class="border-b border-gray-200 dark:border-slate-700"><button class="w-full section-header flex items-center justify-between py-4 font-semibold text-slate-700 dark:text-white" onclick="app.toggleSection(event)"><span>Current Context</span><i class="ni ni-chevron-down text-sm"></i></button><div class="section-content pb-4 px-2"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><p class="text-xs font-semibold text-slate-500 uppercase">Person</p><p id="ctx-person" class="text-sm dark:text-white">-</p></div><div><p class="text-xs font-semibold text-slate-500 uppercase">Account ID</p><p id="ctx-accountId" class="text-sm dark:text-white">-</p></div><div><p class="text-xs font-semibold text-slate-500 uppercase">Balance</p><p id="ctx-balance" class="text-sm font-semibold text-emerald-500">-</p></div><div><p class="text-xs font-semibold text-slate-500 uppercase">Premise</p><p id="ctx-premise" class="text-sm dark:text-white">-</p></div></div></div></div><div class="border-b border-gray-200 dark:border-slate-700"><button class="w-full section-header flex items-center justify-between py-4 font-semibold text-slate-700 dark:text-white" onclick="app.toggleSection(event)"><span>Financial Information</span><i class="ni ni-chevron-down text-sm"></i></button><div class="section-content pb-4 px-2"><div class="space-y-2"><div class="p-3 bg-gray-50 dark:bg-slate-800 rounded"><p class="text-xs font-semibold text-slate-500 uppercase">Current Balance</p><p id="fin-balance" class="text-sm font-semibold text-emerald-500">-</p></div><div class="p-3 bg-gray-50 dark:bg-slate-800 rounded"><p class="text-xs font-semibold text-slate-500 uppercase">Last Payment</p><p id="fin-lastPayment" class="text-sm dark:text-white">-</p></div><div class="p-3 bg-gray-50 dark:bg-slate-800 rounded"><p class="text-xs font-semibold text-slate-500 uppercase">Last Billed</p><p id="fin-lastBilled" class="text-sm dark:text-white">-</p></div><div class="p-3 bg-gray-50 dark:bg-slate-800 rounded"><p class="text-xs font-semibold text-slate-500 uppercase">Previous Bill</p><p id="fin-prevBill" class="text-sm dark:text-white">-</p></div></div></div></div><div class="border-b border-gray-200 dark:border-slate-700"><button class="w-full section-header flex items-center justify-between py-4 font-semibold text-slate-700 dark:text-white" onclick="app.toggleSection(event)"><span>Water Billing History</span><i class="ni ni-chevron-down text-sm"></i></button><div class="section-content pb-4 px-2"><div class="space-y-2"><div class="p-3 bg-gray-50 dark:bg-slate-800 rounded"><p class="text-xs font-semibold text-slate-500 uppercase">Last 3 Months</p><p id="hist-3months" class="text-sm dark:text-white">-</p></div><div class="p-3 bg-gray-50 dark:bg-slate-800 rounded"><p class="text-xs font-semibold text-slate-500 uppercase">Average Usage</p><p id="hist-avgUsage" class="text-sm dark:text-white">-</p></div><div class="p-3 bg-gray-50 dark:bg-slate-800 rounded"><p class="text-xs font-semibold text-slate-500 uppercase">Trend</p><p id="hist-trend" class="text-sm text-orange-500">-</p></div></div></div></div><div class="border-b border-gray-200 dark:border-slate-700"><button class="w-full section-header flex items-center justify-between py-4 font-semibold text-slate-700 dark:text-white" onclick="app.toggleSection(event)"><span>Meter Status</span><i class="ni ni-chevron-down text-sm"></i></button><div class="section-content pb-4 px-2"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><p class="text-xs font-semibold text-slate-500 uppercase">Meter ID</p><p id="meter-id" class="text-sm font-bold dark:text-white">-</p></div><div><p class="text-xs font-semibold text-slate-500 uppercase">Status</p><p id="meter-status" class="text-sm font-bold text-emerald-500">-</p></div><div><p class="text-xs font-semibold text-slate-500 uppercase">Last Reading</p><p id="meter-reading" class="text-sm dark:text-white">-</p></div><div><p class="text-xs font-semibold text-slate-500 uppercase">Reading Date</p><p id="meter-date" class="text-sm dark:text-white">-</p></div></div></div></div><div><button class="w-full section-header flex items-center justify-between py-4 font-semibold text-slate-700 dark:text-white" onclick="app.toggleSection(event)"><span>List of service agreements with status</span><i class="ni ni-chevron-down text-sm"></i></button><div class="section-content pb-4 px-2"><div class="space-y-2"><div class="p-3 bg-gray-50 dark:bg-slate-800 rounded"><p class="text-xs font-semibold text-slate-500 uppercase">Agreement ID</p><p id="agreement-id" class="text-sm dark:text-white">-</p></div><div class="p-3 bg-gray-50 dark:bg-slate-800 rounded"><p class="text-xs font-semibold text-slate-500 uppercase">Service Type</p><p id="agreement-type" class="text-sm dark:text-white">-</p></div><div class="p-3 bg-gray-50 dark:bg-slate-800 rounded"><p class="text-xs font-semibold text-slate-500 uppercase">Status</p><p id="agreement-status" class="text-sm font-semibold text-emerald-500">-</p></div><div class="p-3 bg-gray-50 dark:bg-slate-800 rounded"><p class="text-xs font-semibold text-slate-500 uppercase">Start Date</p><p id="agreement-startDate" class="text-sm dark:text-white">-</p></div></div></div></div></div></div><div id="customerInfo-tab" class="accountTabContent" style="display:none"><div class="overflow-x-auto"><table class="w-full text-sm border-collapse"><thead><tr class="bg-gray-100 dark:bg-slate-700"><th class="px-6 py-4 text-left font-semibold text-slate-700 dark:text-white uppercase text-xs border-b border-gray-300">Account Info</th><th class="px-6 py-4 text-left font-semibold text-slate-700 dark:text-white uppercase text-xs border-b border-gray-300">Current Balance</th><th class="px-6 py-4 text-left font-semibold text-slate-700 dark:text-white uppercase text-xs border-b border-gray-300">Arrears</th><th class="px-6 py-4 text-left font-semibold text-slate-700 dark:text-white uppercase text-xs border-b border-gray-300">Last Billed Info</th><th class="px-6 py-4 text-left font-semibold text-slate-700 dark:text-white uppercase text-xs border-b border-gray-300">Last Contact Info</th></tr></thead><tbody><tr class="border-b border-gray-200 dark:border-slate-700"><td class="px-6 py-4"><div class="font-semibold text-blue-600" id="cust-accountNumber">6435980928 - ŸÖÿ≠ŸÖÿØ ÿßŸÑÿ¥ÿ±ŸäŸÅŸä</div><div class="text-xs text-slate-600 dark:text-slate-400" id="cust-class">Residential Customer Class, SAR86.95</div></td><td class="px-6 py-4"><div class="font-semibold text-slate-700 dark:text-white" id="cust-balance">SAR86.95</div></td><td class="px-6 py-4"><div class="text-slate-700 dark:text-white text-xs font-semibold" id="cust-arrears">Clear</div></td><td class="px-6 py-4"><div class="text-slate-700 dark:text-white text-xs" id="cust-billed">11-03-2025, SAR86.95, Due Date 11-28-2025</div></td><td class="px-6 py-4"><div class="text-blue-600 text-xs" id="cust-contact">Today - Bill Notification - User:Sadad</div></td></tr></tbody></table></div></div><div id="billingInfo-tab" class="accountTabContent" style="display:none"><div class="space-y-0"><div class="border-b border-gray-200 dark:border-slate-700"><button class="w-full section-header flex items-center justify-between py-4 font-semibold text-slate-700 dark:text-white" onclick="app.toggleSection(event)"><span>Bill/Payment Tree</span><i class="ni ni-chevron-down text-sm"></i></button><div class="section-content pb-4 px-2"><div class="text-xs space-y-1"><div class="ml-0 flex items-start"><span class="cursor-pointer hover:text-blue-600 text-slate-700 dark:text-slate-300 font-semibold">üìã Account - <span id="bill-accountId">6435980928</span>, <span id="bill-accountName">ŸÖÿ≠ŸÖÿØ ÿßŸÑÿ¥ÿ±ŸäŸÅŸä</span></span></div><div class="ml-4 text-slate-600 dark:text-slate-400 mb-2"><span id="bill-accountClass">Residential Customer Class, SAR86.95</span></div><div id="billPaymentList" class="ml-4 space-y-2"><div class="ml-0 mt-1 flex items-start"><span class="cursor-pointer hover:text-blue-600 text-slate-700 dark:text-slate-300">üìÑ Bill - <span class="bill-date">Date: 03-11-2025</span>, <span class="bill-status">Complete</span>, Due:<span class="bill-dueDate">11-28-2025</span>, <span class="bill-amount">SAR86.95</span>, <span class="bill-cycle">Al Qasim Monthly Billing cycle1</span> / <span class="bill-billDate">03-11-2025</span></span></div><div class="ml-4 flex items-start"><span class="cursor-pointer hover:text-blue-600 text-slate-700 dark:text-slate-300">üí≥ Pay - <span class="pay-date">Date: 28-10-2025</span>, <span class="pay-status">Frozen</span>, <span class="pay-amount">SAR151.07</span></span></div><div class="ml-0 mt-1 flex items-start"><span class="cursor-pointer hover:text-blue-600 text-slate-700 dark:text-slate-300">üìÑ Bill - <span class="bill-date">Date: 05-10-2025</span>, <span class="bill-status">Complete</span>, Due:<span class="bill-dueDate">28-10-2025</span>, <span class="bill-amount">SAR151.07</span>, <span class="bill-cycle">Al Qasim Monthly Billing cycle1</span> / <span class="bill-billDate">03-10-2025</span></span></div><div class="ml-4 flex items-start"><span class="cursor-pointer hover:text-blue-600 text-slate-700 dark:text-slate-300">üí≥ Pay - <span class="pay-date">Date: 04-09-2025</span>, <span class="pay-status">Frozen</span>, <span class="pay-amount">SAR50.44</span></span></div><div class="ml-0 mt-1 flex items-start"><span class="cursor-pointer hover:text-blue-600 text-slate-700 dark:text-slate-300">üìÑ Bill - <span class="bill-date">Date: 04-09-2025</span>, <span class="bill-status">Complete</span>, Due:<span class="bill-dueDate">28-09-2025</span>, <span class="bill-amount">SAR50.44</span>, <span class="bill-cycle">Al Qasim Monthly Billing cycle1</span> / <span class="bill-billDate">03-09-2025</span></span></div></div></div></div></div><div id="meterInfo-tab" class="accountTabContent" style="display:none"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><p class="text-xs font-semibold text-slate-500 uppercase">Meter ID</p><p id="meterInfo-id" class="text-lg font-bold dark:text-white">-</p></div><div><p class="text-xs font-semibold text-slate-500 uppercase">Status</p><p id="meterInfo-status" class="text-lg font-bold text-emerald-500">-</p></div><div><p class="text-xs font-semibold text-slate-500 uppercase">Last Reading</p><p id="meterInfo-lastReading" class="text-sm dark:text-white">-</p></div><div><p class="text-xs font-semibold text-slate-500 uppercase">Reading Date</p><p id="meterInfo-readingDate" class="text-sm dark:text-white">-</p></div></div></div></div></div></div><div class="lg:col-span-1"><div class="border-black/12.5 dark:bg-slate-850 dark:shadow-dark-xl shadow-xl relative z-20 flex min-w-0 flex-col break-words rounded-2xl border-0 border-solid bg-white bg-clip-border mb-6"><div class="flex-auto p-6"><div class="flex flex-row -mx-3"><div class="flex-none w-2/3 max-w-full px-3"><p class="mb-0 font-sans text-sm font-semibold uppercase dark:opacity-60">Balance</p><h5 id="summaryBalance" class="mb-2 font-bold dark:text-white text-2xl">-</h5><p class="mb-0 dark:opacity-60"><span id="summaryStatus" class="text-sm font-bold text-emerald-500">Good Standing</span></p></div><div class="px-3 text-right basis-1/3"><div class="inline-block w-12 h-12 text-center rounded-circle bg-gradient-to-tl from-emerald-500 to-teal-400"><i class="ni leading-none ni-money-coins text-lg relative top-3.5 text-white"></i></div></div></div></div></div><div class="border-black/12.5 dark:bg-slate-850 dark:shadow-dark-xl shadow-xl relative z-20 flex min-w-0 flex-col break-words rounded-2xl border-0 border-solid bg-white bg-clip-border"><div class="border-black/12.5 mb-0 rounded-t-2xl border-b border-solid p-6 pt-4 pb-3"><h6 class="capitalize dark:text-white">Actions</h6></div><div class="flex-auto p-6"><div class="flex flex-col gap-3"><button class="inline-flex items-center justify-center w-full px-6 py-3 font-bold text-white uppercase bg-blue-500 border-0 rounded-lg text-sm"><i class="ni ni-single-copy-04 mr-2"></i>Generate Bill</button><button class="inline-flex items-center justify-center w-full px-6 py-3 font-bold text-white uppercase bg-emerald-500 border-0 rounded-lg text-sm"><i class="ni ni-chart-bar-32 mr-2"></i>Submit Reading</button></div></div></div></div></div></div></div>`;
                    app.updateSearchFields();
                }
            },
            meter: {
                title: 'Meter Readings',
                breadcrumb: 'Meter Readings',
                render(container) {
                    container.innerHTML = `<div class="border-black/12.5 dark:bg-slate-850 dark:shadow-dark-xl shadow-xl relative z-20 flex min-w-0 flex-col break-words rounded-2xl border-0 border-solid bg-white bg-clip-border"><div class="border-black/12.5 mb-0 rounded-t-2xl border-b border-solid p-6 pt-4 pb-3"><h6 class="capitalize dark:text-white">Meter Readings</h6></div><div class="flex-auto p-6"><p class="dark:text-white mb-4">Submit and track meter readings for all customer accounts.</p><button class="inline-flex items-center px-8 py-2 font-bold text-white uppercase bg-blue-500 border-0 rounded-lg text-sm"><i class="ni ni-plus mr-2"></i>New Reading</button></div></div>`;
                }
            },
            bills: {
                title: 'Bills Management',
                breadcrumb: 'Bills',
                render(container) {
                    container.innerHTML = `<div class="w-full max-w-full"><div class="border-black/12.5 dark:bg-slate-850 dark:shadow-dark-xl shadow-xl relative z-20 flex min-w-0 flex-col break-words rounded-2xl border-0 border-solid bg-white bg-clip-border mb-6"><div class="border-black/12.5 mb-0 rounded-t-2xl border-b-0 border-solid p-6 pt-4 pb-3"><h6 class="capitalize dark:text-white">Bill Search</h6></div><div class="flex-auto p-6"><div class="space-y-4"><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div><label class="block text-sm font-semibold text-slate-700 dark:text-white mb-2">Person Name</label><div class="flex gap-2"><input type="text" id="billSearchPersonName" placeholder="" class="flex-1 px-4 py-2 border border-solid border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none dark:bg-slate-800 dark:text-white"><button onclick="app.searchBills('personName')" class="px-4 py-2 font-bold text-slate-700 uppercase bg-gray-200 border-0 rounded-lg text-sm dark:bg-slate-700 dark:text-white">Search</button></div></div><div><label class="block text-sm font-semibold text-slate-700 dark:text-white mb-2">Bill ID</label><div class="flex gap-2"><input type="text" id="billSearchBillId" placeholder="" class="flex-1 px-4 py-2 border border-solid border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none dark:bg-slate-800 dark:text-white"><button onclick="app.searchBills('billId')" class="px-4 py-2 font-bold text-slate-700 uppercase bg-gray-200 border-0 rounded-lg text-sm dark:bg-slate-700 dark:text-white">Search</button></div></div><div><label class="block text-sm font-semibold text-slate-700 dark:text-white mb-2">Account ID</label><div class="flex gap-2"><input type="text" id="billSearchAccountId" placeholder="" class="flex-1 px-4 py-2 border border-solid border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none dark:bg-slate-800 dark:text-white"><button onclick="app.searchBills('accountId')" class="px-4 py-2 font-bold text-slate-700 uppercase bg-gray-200 border-0 rounded-lg text-sm dark:bg-slate-700 dark:text-white">Search</button></div></div></div><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div><label class="block text-sm font-semibold text-slate-700 dark:text-white mb-2">On or After Bill Date</label><div class="flex gap-2"><input type="date" id="billSearchBillDate" class="flex-1 px-4 py-2 border border-solid border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none dark:bg-slate-800 dark:text-white"><button onclick="app.searchBills('billDate')" class="px-4 py-2 font-bold text-slate-700 uppercase bg-gray-200 border-0 rounded-lg text-sm dark:bg-slate-700 dark:text-white">Search</button></div></div><div><label class="block text-sm font-semibold text-slate-700 dark:text-white mb-2">CR Note from Bill ID</label><div class="flex gap-2"><input type="text" id="billSearchCrNote" placeholder="" class="flex-1 px-4 py-2 border border-solid border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none dark:bg-slate-800 dark:text-white"><button onclick="app.searchBills('crNote')" class="px-4 py-2 font-bold text-slate-700 uppercase bg-gray-200 border-0 rounded-lg text-sm dark:bg-slate-700 dark:text-white">Search</button></div></div><div><label class="block text-sm font-semibold text-slate-700 dark:text-white mb-2">Characteristic Type</label><div class="flex gap-2"><input type="text" id="billSearchCharType" placeholder="" class="flex-1 px-4 py-2 border border-solid border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none dark:bg-slate-800 dark:text-white"><button onclick="app.searchBills('charType')" class="px-4 py-2 font-bold text-slate-700 uppercase bg-gray-200 border-0 rounded-lg text-sm dark:bg-slate-700 dark:text-white">Search</button></div></div></div><div class="grid grid-cols-1 gap-4"><div><label class="block text-sm font-semibold text-slate-700 dark:text-white mb-2">Characteristic Value</label><div class="flex gap-2"><input type="text" id="billSearchCharValue" placeholder="" class="flex-1 px-4 py-2 border border-solid border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none dark:bg-slate-800 dark:text-white"><button onclick="app.searchBills('charValue')" class="px-4 py-2 font-bold text-slate-700 uppercase bg-gray-200 border-0 rounded-lg text-sm dark:bg-slate-700 dark:text-white">Search</button></div></div></div></div></div></div><div class="border-black/12.5 dark:bg-slate-850 dark:shadow-dark-xl shadow-xl relative z-20 flex min-w-0 flex-col break-words rounded-2xl border-0 border-solid bg-white bg-clip-border"><div class="border-black/12.5 mb-0 rounded-t-2xl border-b border-solid p-6 pt-4 pb-3"><h6 class="capitalize dark:text-white">Bill Results</h6></div><div class="overflow-x-auto p-6"><table class="w-full text-sm border-collapse"><thead><tr class="bg-gray-100 dark:bg-slate-700"><th class="px-4 py-3 text-left font-semibold text-slate-700 dark:text-white uppercase text-xs border-b border-gray-300">Person Name</th><th class="px-4 py-3 text-left font-semibold text-slate-700 dark:text-white uppercase text-xs border-b border-gray-300">Bill Status</th><th class="px-4 py-3 text-left font-semibold text-slate-700 dark:text-white uppercase text-xs border-b border-gray-300">Bill Date</th><th class="px-4 py-3 text-left font-semibold text-slate-700 dark:text-white uppercase text-xs border-b border-gray-300">Due Date</th><th class="px-4 py-3 text-left font-semibold text-slate-700 dark:text-white uppercase text-xs border-b border-gray-300">Current Charges</th><th class="px-4 py-3 text-left font-semibold text-slate-700 dark:text-white uppercase text-xs border-b border-gray-300">Bill ID</th><th class="px-4 py-3 text-left font-semibold text-slate-700 dark:text-white uppercase text-xs border-b border-gray-300">Original Bill Date</th><th class="px-4 py-3 text-left font-semibold text-slate-700 dark:text-white uppercase text-xs border-b border-gray-300">Account ID</th></tr></thead><tbody id="billResultsTable"><tr><td colspan="8" class="px-4 py-4 text-center text-slate-500">Enter search criteria to view results</td></tr></tbody></table></div></div></div>`;
                }
            },
            reports: {
                title: 'Reports & Analytics',
                breadcrumb: 'Reports',
                render(container) {
                    container.innerHTML = `<div class="border-black/12.5 dark:bg-slate-850 dark:shadow-dark-xl shadow-xl relative z-20 flex min-w-0 flex-col break-words rounded-2xl border-0 border-solid bg-white bg-clip-border"><div class="border-black/12.5 mb-0 rounded-t-2xl border-b border-solid p-6 pt-4 pb-3"><h6 class="capitalize dark:text-white">Reports & Analytics</h6></div><div class="flex-auto p-6"><p class="dark:text-white">Comprehensive billing reports, revenue analysis, and system analytics.</p></div></div>`;
                }
            },
            profile: {
                title: 'User Profile',
                breadcrumb: 'Profile',
                render(container) {
                    container.innerHTML = `<div class="border-black/12.5 dark:bg-slate-850 dark:shadow-dark-xl shadow-xl relative z-20 flex min-w-0 flex-col break-words rounded-2xl border-0 border-solid bg-white bg-clip-border"><div class="border-black/12.5 mb-0 rounded-t-2xl border-b border-solid p-6 pt-4 pb-3"><h6 class="capitalize dark:text-white">Profile Settings</h6></div><div class="flex-auto p-6"><p class="dark:text-white">Manage your user profile, preferences, and account settings.</p></div></div>`;
                }
            }
        };

        app.updateSearchFields = function() {
            const searchType = document.getElementById('searchType').value;
            const fieldsDiv = document.getElementById('searchFields');
            const config = {
                name: '<input type="text" placeholder="Name" class="px-4 py-2 border border-gray-300 rounded-lg dark:bg-slate-800 dark:text-white"><input type="text" placeholder="Address" class="px-4 py-2 border border-gray-300 rounded-lg dark:bg-slate-800 dark:text-white"><input type="text" placeholder="City" class="px-4 py-2 border border-gray-300 rounded-lg dark:bg-slate-800 dark:text-white">',
                account_id: '<input type="text" placeholder="Account ID" class="px-4 py-2 border border-gray-300 rounded-lg dark:bg-slate-800 dark:text-white">',
                phone: '<input type="tel" placeholder="Phone" class="px-4 py-2 border border-gray-300 rounded-lg dark:bg-slate-800 dark:text-white">'
            };
            fieldsDiv.innerHTML = config[searchType];
        };

        app.performSearch = function() {
            const searchType = document.getElementById('searchType').value;
            const fieldsDiv = document.getElementById('searchFields');
            let searchValue = '';
            
            // Get the first input field value
            const inputs = fieldsDiv.querySelectorAll('input');
            if (inputs.length > 0) {
                searchValue = inputs[0].value;
            }
            
            if (!searchValue) {
                alert('Please enter a search value');
                return;
            }
            
            // Call PHP API endpoint for accounts
            const apiUrl = new URL('/NWCBilling/api/accounts.php', window.location.origin);
            apiUrl.searchParams.append('action', 'search');
            apiUrl.searchParams.append('searchType', searchType);
            apiUrl.searchParams.append('searchValue', searchValue);
            
            fetch(apiUrl.toString())
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data.length > 0) {
                        const tableBody = document.getElementById('searchResultsTable');
                        tableBody.innerHTML = '<table class="w-full text-sm"><thead><tr class="bg-gray-100"><th class="px-4 py-2 text-left">Account ID</th><th class="px-4 py-2 text-left">Name</th><th class="px-4 py-2 text-left">Phone</th><th class="px-4 py-2 text-left">Balance</th></tr></thead><tbody>' + 
                            data.data.map(acc => `<tr class="border-b hover:bg-gray-50 cursor-pointer" onclick="app.loadAccountDetails('${acc.accountId}')"><td class="px-4 py-2">${acc.accountId}</td><td class="px-4 py-2">${acc.personName}</td><td class="px-4 py-2">${acc.phone || 'N/A'}</td><td class="px-4 py-2 font-semibold">${acc.balance}</td></tr>`).join('') + 
                            '</tbody></table>';
                        document.getElementById('resultsSection').style.display = 'block';
                    } else {
                        document.getElementById('searchResultsTable').innerHTML = '<p class="text-center text-slate-500 p-4">No results found</p>';
                        document.getElementById('resultsSection').style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Search error:', error);
                    alert('Error searching accounts. Please try again.');
                });
        };

        app.loadAccountDetails = function(accountId) {
            const apiUrl = new URL('/NWCBilling/api/accounts.php', window.location.origin);
            apiUrl.searchParams.append('action', 'get');
            apiUrl.searchParams.append('accountId', accountId);
            
            fetch(apiUrl.toString())
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const account = data.account;
                        const meters = data.meters;
                        
                        // Update Current Context
                        document.getElementById('ctx-person').textContent = account.personName;
                        document.getElementById('ctx-accountId').textContent = account.accountId;
                        document.getElementById('ctx-balance').textContent = account.balance;
                        document.getElementById('ctx-premise').textContent = account.premise;
                        
                        // Update Summary Balance
                        document.getElementById('summaryBalance').textContent = account.balance;
                        
                        // Update Meter Info
                        if (meters) {
                            document.getElementById('meter-id').textContent = meters.meterId || 'N/A';
                            document.getElementById('meter-status').textContent = meters.meterStatus || 'N/A';
                            document.getElementById('meter-reading').textContent = meters.lastReading || 'N/A';
                            document.getElementById('meter-date').textContent = meters.lastReadingDate || 'N/A';
                        }
                        
                        document.getElementById('accountDetailsSection').style.display = 'block';
                        setTimeout(() => document.getElementById('accountDetailsSection').scrollIntoView({ behavior: 'smooth' }), 200);
                    }
                })
                .catch(error => {
                    console.error('Error loading account details:', error);
                    alert('Error loading account details. Please try again.');
                });
        };

        app.clearSearch = function() {
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('accountDetailsSection').style.display = 'none';
        };

        app.selectAccount = function() {
            document.getElementById('accountDetailsSection').scrollIntoView({ behavior: 'smooth' });
        };

        app.switchTab = function(event) {
            const btn = event.target;
            const tab = btn.getAttribute('data-tab');
            document.querySelectorAll('.accountTab').forEach(b => {
                b.classList.remove('bg-blue-500', 'text-white');
                b.classList.add('bg-gray-200', 'text-slate-700', 'dark:bg-slate-700');
            });
            btn.classList.remove('bg-gray-200', 'text-slate-700', 'dark:bg-slate-700');
            btn.classList.add('bg-blue-500', 'text-white');
            document.querySelectorAll('.accountTabContent').forEach(c => c.style.display = 'none');
            document.getElementById(tab + '-tab').style.display = 'block';
        };

        app.populateAccountDetails = function() {
            // Current Context
            document.getElementById('ctx-person').textContent = 'ŸÖÿ≠ŸÖÿØ ÿßŸÑÿ¥ÿ±ŸäŸÅŸä';
            document.getElementById('ctx-accountId').textContent = '6435980928';
            document.getElementById('ctx-balance').textContent = 'SAR 86.95';
            document.getElementById('ctx-premise').textContent = 'Al Qasim, Home';
            
            // Account Information
            document.getElementById('accInfo-accountId').textContent = '6435980928';
            document.getElementById('accInfo-class').textContent = 'Residential';
            document.getElementById('accInfo-balance').textContent = 'SAR 86.95';
            document.getElementById('accInfo-status').textContent = 'Active';
            
            // Financial Information
            document.getElementById('fin-balance').textContent = 'SAR 86.95';
            document.getElementById('fin-lastPayment').textContent = '28-10-2025, SAR 151.07';
            document.getElementById('fin-lastBilled').textContent = '03-11-2025, SAR 86.95';
            document.getElementById('fin-prevBill').textContent = '05-10-2025, SAR 151.07';
            
            // Water Billing History
            document.getElementById('hist-3months').textContent = '2.5 m¬≥/day average';
            document.getElementById('hist-avgUsage').textContent = '2,456 m¬≥ total (3 months)';
            document.getElementById('hist-trend').textContent = 'Stable consumption';
            
            // Meter Status
            document.getElementById('meter-id').textContent = 'MTR-001245';
            document.getElementById('meter-status').textContent = 'Active';
            document.getElementById('meter-reading').textContent = '2,456 m¬≥';
            document.getElementById('meter-date').textContent = '10-12-2025';
            
            // Premise Information
            document.getElementById('premise-fullInfo').textContent = 'N.A, ŸÇÿµÿ™Ÿäÿå ÿßŸÑÿØÿ±ÿ©, Al Qasim Directorate (House Connection Number 104255)';
            document.getElementById('premise-csDivision').textContent = 'Al Qasim Directorate';
            document.getElementById('premise-adminSector').textContent = 'N/A';
            document.getElementById('premise-buildingArea').textContent = '800';
            document.getElementById('premise-cityName').textContent = 'Riyadh';
            document.getElementById('premise-borderDesc').textContent = 'ÿπÿ±ÿ® ŸÉÿ±ÿ™ŸàŸÜŸäÿå ÿßŸÑÿ¥ÿ±ŸäŸÅŸäÿå ÿπÿ±ÿ®ÿå ŸÖÿ≥ÿ™Ÿàÿ®ÿ©';
            document.getElementById('premise-borderDist').textContent = '1,550 / 2,000 / 1,900 / 1,950 meters';
            document.getElementById('premise-borderDistStr').textContent = 'East: 1,550m, West: 2,000m, North: 1,900m, South: 1,950m';
            
            // List of service agreements with status
            document.getElementById('agreement-id').textContent = 'AGR-2024-001245';
            document.getElementById('agreement-type').textContent = 'Residential Water Supply';
            document.getElementById('agreement-status').textContent = 'Active';
            document.getElementById('agreement-startDate').textContent = '01-01-2023';
            
            // Customer Information
            document.getElementById('custInfo-name').textContent = 'ŸÖÿ≠ŸÖÿØ ÿßŸÑÿ¥ÿ±ŸäŸÅŸä';
            document.getElementById('custInfo-phone').textContent = '+966 56 056 7271';
            document.getElementById('custInfo-email').textContent = 'mohammed@example.com';
            document.getElementById('custInfo-address').textContent = 'Al Qasim Directorate';
            
            // Billing Information
            document.getElementById('billInfo-lastPayment').textContent = '28-10-2025, SAR 151.07';
            document.getElementById('billInfo-lastBilled').textContent = '03-11-2025, SAR 86.95';
            document.getElementById('billInfo-prevBill').textContent = '05-10-2025, SAR 151.07';
            document.getElementById('meterInfo-id').textContent = 'MTR-001245';
            document.getElementById('meterInfo-status').textContent = 'Active';
            document.getElementById('meterInfo-lastReading').textContent = '2,456 m¬≥';
            document.getElementById('meterInfo-readingDate').textContent = '10-12-2025';
            document.getElementById('summaryBalance').textContent = 'SAR 86.95';
            document.getElementById('summaryStatus').textContent = 'Good Standing';
        };

        // Handle sidebar close button
        document.addEventListener('click', function(e) {
            if (e.target.getAttribute('sidenav-close')) {
                document.querySelector('[sidenav-main]').classList.add('-translate-x-full');
            }
            // Close modal when clicking outside
            if (e.target.id === 'billModal') {
                app.closeBillModal();
            }
        });

        // Initialize dashboard on page load
        window.addEventListener('load', () => {
            app.navigate('dashboard');
        });
    </script>

    <!-- BILL MODAL POPUP -->
    <div id="billModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
        <div class="bg-white dark:bg-slate-850 rounded-2xl shadow-2xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <!-- Modal Header -->
            <div class="border-b border-gray-200 dark:border-slate-700 p-6 flex items-center justify-between">
                <h3 class="text-xl font-bold text-slate-700 dark:text-white">Bill Details</h3>
                <button onclick="app.closeBillModal()" class="text-slate-500 hover:text-slate-700 dark:hover:text-slate-300 text-2xl font-light leading-none">
                    <i class="ni ni-fat-remove"></i>
                </button>
            </div>

            <!-- Modal Content -->
            <div class="p-6 space-y-6">
                <!-- Customer Information Section -->
                <div class="border-b border-gray-200 dark:border-slate-700 pb-6">
                    <h4 class="text-sm font-semibold text-slate-500 uppercase dark:text-slate-400 mb-4">Customer Information</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p class="text-xs font-semibold text-slate-500 uppercase dark:text-slate-400">Person Name</p>
                            <p id="modalPersonName" class="text-sm font-semibold text-slate-700 dark:text-white mt-1">-</p>
                        </div>
                        <div>
                            <p class="text-xs font-semibold text-slate-500 uppercase dark:text-slate-400">Account ID</p>
                            <p id="modalAccountId" class="text-sm font-semibold text-blue-600 dark:text-blue-400 mt-1">-</p>
                        </div>
                    </div>
                </div>

                <!-- Bill Information Section -->
                <div class="border-b border-gray-200 dark:border-slate-700 pb-6">
                    <h4 class="text-sm font-semibold text-slate-500 uppercase dark:text-slate-400 mb-4">Bill Information</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <p class="text-xs font-semibold text-slate-500 uppercase dark:text-slate-400">Bill ID</p>
                            <p id="modalBillId" class="text-sm font-semibold text-slate-700 dark:text-white mt-1">-</p>
                        </div>
                        <div>
                            <p class="text-xs font-semibold text-slate-500 uppercase dark:text-slate-400">Bill Status</p>
                            <p id="modalBillStatus" class="text-sm font-semibold text-emerald-600 dark:text-emerald-400 mt-1">-</p>
                        </div>
                        <div>
                            <p class="text-xs font-semibold text-slate-500 uppercase dark:text-slate-400">Bill Date</p>
                            <p id="modalBillDate" class="text-sm text-slate-700 dark:text-white mt-1">-</p>
                        </div>
                        <div>
                            <p class="text-xs font-semibold text-slate-500 uppercase dark:text-slate-400">Due Date</p>
                            <p id="modalDueDate" class="text-sm text-slate-700 dark:text-white mt-1">-</p>
                        </div>
                        <div>
                            <p class="text-xs font-semibold text-slate-500 uppercase dark:text-slate-400">Original Bill Date</p>
                            <p id="modalOriginalBillDate" class="text-sm text-slate-700 dark:text-white mt-1">-</p>
                        </div>
                    </div>
                </div>

                <!-- Charges Section -->
                <div class="bg-blue-50 dark:bg-slate-800 rounded-lg p-4">
                    <p class="text-xs font-semibold text-slate-500 uppercase dark:text-slate-400 mb-2">Current Charges</p>
                    <p id="modalCurrentCharges" class="text-2xl font-bold text-blue-600 dark:text-blue-400">-</p>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="border-t border-gray-200 dark:border-slate-700 p-6 flex justify-end gap-3">
                <button onclick="app.closeBillModal()" class="px-6 py-2 font-bold text-white uppercase bg-slate-500 border-0 rounded-lg text-sm hover:bg-slate-600 transition-colors">
                    Close
                </button>
            </div>
        </div>
    </div>
</body>
</html>
